#! /bin/bash
set -e

# Download logfiles from public server, renaming them by
# their timestamps so we store all the data forever.

USER=francis@sphinx.mythic-beasts.com

cd logs
mkdir -p tmpdownload
cd tmpdownload

rsync -v --progress --delete -az -e "ssh" $USER:./www.publicwhip.org.uk_logs/*.gz .

for X in access_log.*.gz
do
    DATE=`stat --terse --format=%y $X | cut -d "." -f 1 | tr " " "-"`
    cp -a $X ../access_log.$DATE.gz
done
cp -a access_log ../
cd ../..

# Make log file analysis from awsats
zcat `ls -1 logs/*.gz | sort` | cat - logs/access_log | /usr/lib/cgi-bin/awstats.pl -config=publicwhip.org.uk
/usr/share/doc/awstats/examples/awstats_buildstaticpages.pl -config=publicwhip.org.uk -dir=logs/awstats -awstatsprog=/usr/lib/cgi-bin/awstats.pl

rsync -e ssh -Pva logs/awstats/ francis@sphinx.mythic-beasts.com:~/public_html/pwstats/

