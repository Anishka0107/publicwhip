#! /bin/bash

USER=francis@sphinx.mythic-beasts.com

if [ -z "$REMOTE_DIR" ]
then
    echo "Please run upload-web or upload-staging"
    exit 1
fi

echo "Fetching from CVS..."
rm -fr tmpuploadcopy
cvs export -r HEAD -d tmpuploadcopy publicwhip/website

echo "Extracting headlines..."
cd tmpuploadcopy
../build/extractheadlines
cd ..

echo "Adding FastCGI header..."
cd tmpuploadcopy
for X in *.php account/*.php
do
    echo "#! /software/bin/php4-fcgi" >tmp.php
    cat $X >> tmp.php
    mv tmp.php $X
done
cd ..

echo "Uploading web pages..."
rsync -v --progress --delete -az -e "ssh" tmpuploadcopy/ $USER:$REMOTE_DIR
ssh $USER "chmod 0755 $REMOTE_DIR"
ssh $USER "chmod 0755 $REMOTE_DIR/*.php"
ssh $USER "chmod 0755 $REMOTE_DIR/account"
ssh $USER "chmod 0755 $REMOTE_DIR/account/*.php"

